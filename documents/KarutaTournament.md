# かるた大会運営支援アプリケーション群 仕様書（修正版）

## 1. プロジェクト概要

### 1.1. アプリケーション群開発の目的

- かるたの大会運営をデジタル化し、人的ミスを削減しつつ、運営にかかる作業工数を減らす。  
- 複数試合・多クラス対応のトーナメント形式の管理をシンプルかつ正確に行う。  

### 1.2. 想定する大会・利用状況

- **大会形式（2種類）**  
  1. **単純なトーナメント形式**  
     - 32名または64名を1クラスとして最大10クラス程度運営。  
  2. **トーナメント＋敗者同士の交流戦**  
     - 本戦で1度負けたら交流戦へ回る。交流戦は「練習試合」として実施するため、最終的な成績（優勝・順位）には影響しないが、対戦結果の記録としては残す。  

- 運営スタッフがメインで使用し、出力結果は参加者にも共有される。

### 1.3. 対応予定の競技規程

- **全日本かるた協会の競技規程および競技会規程**  
- **組み合わせアルゴリズムは既にJavaScriptで実装済み**（後日、本ツールに組み込む前提）。

### 1.4. 対象ユーザ

- 大会の運営スタッフ（当面は単一端末での運用を想定するが、将来的に複数端末利用の可能性あり）。  
- 参加者は「対戦表・結果表・成績表」などの出力を参照。

### 1.5. 対応プラットフォーム・動作環境

- **Webアプリ（PC・モバイル対応）、オフライン可**  
  - バックエンドを持たない（HTML＋JavaScriptのみで動作）  
  - CSVの読み書きは、ファイル操作やテキストの貼り付けで対応  
  - ローカルPCやタブレットのブラウザ上で動かすことを想定

### 1.6. 想定納期・リリーススケジュール

- **1週間で完成**させる  
  - まず「対戦組み合わせ決定ツール」「対戦結果入力ツール」を優先実装  
  - 「総合結果作成ツール」は後回しでもよい  

---

## 2. 共通要件

### 2.1. 使用技術・言語

- **フロントエンド**: HTML + JavaScript
- **バックエンド**: なし
- **データ保存**: CSVファイル（読み込み・書き出し）

### 2.2. 認証・認可

- インターネットに公開する形を想定（パスワード等は実装しない想定、将来的に拡張の可能性あり）。

### 2.3. UI/UX の方針

- シンプルでわかりやすいUI（**日本語のみ対応**）  
- レスポンシブ対応（PC・モバイル両方で閲覧しやすい）  
- ユニバーサルデザインを考慮（ただし視覚障害への特別対応は不要）

### 2.4. 拡張性・保守性

- 大会規模拡大や競技規程改定への対応を見据え、コードの拡張が容易な設計にする。

### 2.5. 権限・ユーザ管理

- 当面は単一ユーザ入力を前提とする。  
- 同時操作は将来的な課題。

### 2.6. セキュリティ・データ保護

- 参加者情報や試合結果は、外部送信せずローカルで完結可能。  
- スタンドアロンでも使用できるようにする。

### 2.7. ログ・監査証跡

- **不要**（現段階ではログ保管の要件なし）。

### 2.8. バックアップ・リカバリ

- **不要**（CSVファイルを大会運営者側がバックアップすればOK）。

### 2.9. **画面レイアウト・操作性**

- **ワイヤーフレーム**: 具体的な画面構成はすでに用意あり。後日共有・実装時に反映予定。  
- **印刷を想定した画面**は不要（PNG出力の機能があれば十分）。  
- **1画面で複数クラスを管理**できるようにすると望ましい（将来的対応も含む）。

---

## 3. 全体的な動作フロー

1. **大会の開始**  
   - 参加者名簿 (例: `1stPlayers.csv`) を取り込み。  
2. **1試合目の対戦組み合わせ作成**（対戦組み合わせ決定ツール）  
   - 入力: `1stPlayers.csv`  
   - 出力: `1stMatch.csv`, `1stMatch.png`, HTML画面表示  
3. **1試合目の結果入力**（対戦結果入力ツール）  
   - 入力: `1stMatch.csv` (対戦表) + ユーザ操作  
   - 出力:  
     - `1stResult.csv`（結果一覧）  
     - `1stResult.png`  
     - HTML表示  
     - 次ラウンド参加者名簿 `2ndPlayers.csv`  
4. **2試合目の対戦組み合わせ作成**  
   - 入力: `2ndPlayers.csv`  
   - 出力: `2ndMatch.csv`, `2ndMatch.png`, HTML表示  
5. **2試合目の結果入力**  
   - 入力: `2ndMatch.csv` + ユーザ操作  
   - 出力:  
     - `2ndResult.csv`  
     - `2ndResult.png`  
     - 次ラウンド参加者名簿 `3rdPlayers.csv`  
6. **…（同様に必要試合数分繰り返し）…**  
7. **最終試合の結果入力**  
   - 入力: `nthMatch.csv`  
   - 出力: `nthResult.csv`  
8. **総合結果作成**（総合結果作成ツール）  
   - 入力: `1stResult.csv, 2ndResult.csv, …, nthResult.csv`  
   - 出力:  
     - `allMatchResult.csv`（最終的な成績表）  
     - PDF出力（優勝・準優勝・ベスト4などの表彰リスト付き）

---

## 4. 各ツール仕様

### 4.1. 対戦組み合わせ決定ツール

#### 4.1.1. 概要

- 参加者名簿 CSV を元に、**既存のJavaScript実装済みアルゴリズム**を用いて対戦組み合わせを生成。  
- 画面表示・CSV出力・PNG出力（表形式）を行う。

#### 4.1.2. 対戦組み合わせアルゴリズム

- 全日本かるた協会の規定をベースとし、**後日提供される既存JSコードを組み込む**。  
- トーナメントのみ／敗者同士（交流戦）も含む組み合わせを生成。  

#### 4.1.3. 入力データ

- **参加者名簿 CSV**  
  - またはCSV形式テキストを貼り付け  
- カラム例  
  1. ID  
  2. 級  
  3. 組  
  4. 所属  
  5. 名前（姓と名）  
  6. 名前読み（姓読みと名読み）  
  7. 欠席（true/false）  
  8. 敗退済（true/false）  
  9. n試合目相手ID  
  10. n試合目結果 (勝/負/不戦勝)  
  11. n試合目枚差 (整数)

#### 4.1.4. 出力データ

1. **対戦組み合わせ CSV** (例: `1stMatch.csv`)  
   - シンプルな表形式を想定（席番号ごとにペアを並べる）。  
   - カラム例:  
     - 級  
     - 組  
     - 席番号  
     - 左ID / 左名前 / 左所属  
     - 右ID / 右名前 / 右所属  
     - 不戦勝フラグ  
2. **対戦組み合わせ PNG** (例: `1stMatch.png`)  
   - シンプルなテーブルをCanvas等で生成し、画像出力。  
   - トーナメントツリーではなく表形式でOK。  
3. **HTML画面表示**  
   - ブラウザ上で確認・簡易印刷ができるページ。

#### 4.1.5. 操作フロー

1. 参加者データ（CSV）を読み込む  
2. 組み合わせロジック(JS)を実行  
3. 画面上に表形式で対戦カード一覧を表示  
4. CSV・PNGダウンロードボタンから出力可能にする

#### 4.1.6. 実行回数

- 1大会につき複数ラウンド（例: 1回戦、2回戦…）。

---

### 4.2. 対戦結果入力ツール

#### 4.2.1. 概要

- 組み合わせCSVを参照しながら試合結果（勝敗・枚差）を入力し、結果一覧CSVと次ラウンド用参加者CSVを出力する。  
- **1画面で席番号順に一覧を表示**し、各行で「勝者」「枚差」を入力できるテーブルを用意する。

#### 4.2.2. 対戦結果入力項目

- **勝敗**（左勝/右勝/不戦勝 など）  
- **枚差**（整数）  
- **席番号順**に以下のようなテーブル表示をイメージ:  

| 左席番号 | 左名前 | 左所属 | 右席番号 | 右名前 | 右所属 | 勝者(入力UI) | 枚差(入力UI) | 入力確定ボタン |
|:--------:|:------:|:------:|:--------:|:------:|:------:|:------------:|:------------:|:--------------:|
| (自動)   | (自動) | (自動) | (自動)   | (自動) | (自動) | (ドロップダウン等) | (テキストBOX) | (押下で登録)   |

#### 4.2.3. 入力フロー・権限

1. 基本的に1台の端末で運用（将来的に拡張予定）。  
2. 入力確定ボタン後、再編集する場合は確認アラート表示。

#### 4.2.4. 次の試合に勝ち進む仕組み

- 入力内容に基づき勝者（または不戦勝者）のみを抽出し、`(n+1)thPlayers.csv`を自動生成。  
- **敗者は「敗退済 = true」**になるが、**交流戦の場合も同様に対戦結果は記録**する。  
  - ただし交流戦の成績は「本戦優勝」には影響しない。

#### 4.2.5. 出力データ

1. **対戦結果 CSV** (例: `1stResult.csv`)  
   - カラム例:  
     - 級、組、席番号  
     - 左ID / 左名前 / 左所属  
     - 右ID / 右名前 / 右所属  
     - 不戦勝フラグ  
     - 勝者  
     - 枚差  
2. **次ラウンド参加者名簿 CSV** (例: `2ndPlayers.csv`)  
   - 参加者名簿と同等のカラムを持ち、今回試合結果を反映（勝ち残りのみ有効）。

#### 4.2.6. 連携方法

- **対戦組み合わせ決定ツール → 対戦結果入力ツール**  
  - CSVファイル（例: `1stMatch.csv`）を読み込み  
- **対戦結果入力ツール → 総合結果作成ツール**  
  - CSVファイル（例: `1stResult.csv`）を渡す  

---

### 4.3. 総合結果作成ツール

#### 4.3.1. 概要

- 各試合の結果CSVを集約し、最終成績表を作成する。  
- 個人戦のみ。**敗者交流戦の結果**も参考として表示可能だが、**優勝や順位には影響しない**。

#### 4.3.2. 入力データ

- **複数の試合結果 CSV**（最大6試合想定）  
  - `1stResult.csv` ～ `6thResult.csv` など

#### 4.3.3. 出力内容

1. **総合結果 CSV** (例: `allMatchResult.csv`)  
   - 参加者ID、基本情報（名前・所属など）、全試合の勝敗・枚差など  
   - **トーナメントの場合、全勝者が複数名出た場合は全員優勝扱い**  
2. **PDF**  
   - 上記内容の一覧表  
   - 優勝・準優勝・ベスト4を強調表示（同率優勝があれば全員を優勝と表示）

#### 4.3.4. 表示項目例

- 優勝者（全勝者）  
- 準優勝者（決勝で1敗）  
- ベスト4（準決勝で敗れた選手）  
- その他順位・勝敗数・総枚差（必要に応じて）

#### 4.3.5. PDF出力実装方法

- **ライブラリ利用の可能性**  
  - JavaScriptのみでのPDF生成は `pdfmake` や `jsPDF` などを使用するのが一般的。  
  - ライブラリなしだとHTML→PDF変換は困難なため、**適宜ライブラリを活用**する方向で検討。

---

## 5. 開発体制・プロジェクトマネジメント

### 5.1. 開発規模・人数

- **個人開発**（開発者1名、UIデザインも兼任）

### 5.2. プロジェクト管理手法

- 簡易ウォーターフォールもしくはアジャイル（短期開発のため柔軟に対応）

### 5.3. テスト方針

- 単体テスト（主要機能を簡易テスト）  
- データ整合性やCSV入出力の確認を重点的に

### 5.4. ドキュメント整備方針

- **要件定義書・仕様書・設計書をまとめた「基本設計ドキュメント」**を作成  
- 併せて、**利用マニュアル**（操作手順書）を用意

### 5.5. 保守運用

- 大会終了後はCSVを保管するだけでOK  
- バージョンアップ要望があれば協議の上対応（GitHub上で改善コメントを受け付ける想定）

### 5.6. **配布形態・ライセンス**

- **GitHub** で公開し、自由に利用（再配布）可能とする  
- 大会運営スタッフ向けには、完成後にZIP配布などで提供

---

## 6. CSV入出力の詳細仕様

1. **文字コード**  
   - **入力**: Shift_JIS / UTF-8(BOMあり/なし) を受け付けるようにする  
   - **出力**: **UTF-8(BOMあり)** を基本とする  
2. **区切り文字**  
   - **`,`（カンマ）**。Excelとの互換性を考慮して実装  
3. **カラムの順序**  
   - 仕様書の例は必須データを記載したもの。  
   - 将来的にカラム追加・変更の可能性あり

---

## 7. その他要件・確認事項

1. **UIデザイン・ブランド要素**  
   - 大会名や画面配色程度は指定できるようにする  
   - ロゴ画像の差し込みは不要（今のところ）  
2. **過去データの取り込み・アーカイブ**  
   - 過去データの閲覧機能は不要（単純にCSVを参照するのみ）  
3. **複数端末での同時入力**  
   - 将来的な拡張要件。ファイル同期 / クラウド保存など今後検討  
4. **同率順位が複数名発生した場合**  
   - トーナメント形式なので、全勝者が複数いる場合は全員優勝扱い  
   - 順位付けは行わない  

---

## 付録：入出力情報リスト

### 1) 参加者名簿 CSV（例: `nPlayers.csv`）

| カラム名            | 説明                                                              |
|---------------------|-------------------------------------------------------------------|
| ID                  | ユニークID                                                        |
| 級                  | 例: A級, B級, …                                                   |
| 組                  | 大会内のクラス（トーナメントを分ける単位）                        |
| 所属                | 選手の所属（チーム／都道府県など）                                |
| 名前（姓と名）      | 選手の本名                                                        |
| 名前読み（姓/名）   | フリガナ                                                          |
| 欠席                | 欠場の場合はtrue, 出場の場合はfalse                               |
| 敗退済              | 既に敗退している場合はtrue, それ以外はfalse                       |
| n試合目相手ID       | 過去ラウンド対戦相手ID（例: 1回戦の相手、2回戦の相手…）          |
| n試合目結果         | 勝/負/不戦勝などのステータス                                     |
| n試合目枚差         | 取り札枚差、またはスコア差（整数）                               |

### 2) 対戦組み合わせ CSV（例: `nMatch.csv`）

| カラム名   | 説明                                             |
|------------|--------------------------------------------------|
| 級         | A級 / B級 …                                      |
| 組         | クラス・組名称                                    |
| 席番号     | 試合会場内での座席番号                           |
| 左ID       | 左側選手のID                                     |
| 左名前     | 左側選手の名前                                   |
| 左所属     | 左側選手の所属                                   |
| 右ID       | 右側選手のID                                     |
| 右名前     | 右側選手の名前                                   |
| 右所属     | 右側選手の所属                                   |
| 不戦勝     | 左 or 右が不戦勝の場合にtrue (または空欄)        |

### 3) 対戦結果 CSV（例: `nResult.csv`）

| カラム名   | 説明                                                       |
|------------|------------------------------------------------------------|
| 級         | 試合が行われた級                                           |
| 組         | 組名/クラス名                                             |
| 席番号     | 座席番号                                                   |
| 左ID       | 左側選手のID                                               |
| 左名前     | 左側選手の名前                                             |
| 左所属     | 左側選手の所属                                             |
| 右ID       | 右側選手のID                                               |
| 右名前     | 右側選手の名前                                             |
| 右所属     | 右側選手の所属                                             |
| 不戦勝     | 該当する場合のみtrue                                       |
| 勝者       | 左IDまたは右ID                                             |
| 枚差       | 取り札枚差                                                 |

### 4) 次ラウンド参加者名簿 CSV（例: `(n+1)thPlayers.csv`）

- 参加者名簿 (`nPlayers.csv`) と同じカラム構成  
- 勝者のみ残し、今回の試合結果を反映（例: `n試合目結果 = '勝'`、敗者は `敗退済 = true` など）。

### 5) 総合結果 CSV（例: `allMatchResult.csv`）

| カラム名             | 説明                                                           |
|----------------------|----------------------------------------------------------------|
| ID                   | 参加者のユニークID                                            |
| 級                   | A級 / B級 …                                                   |
| 組                   | クラス・組                                                    |
| 所属                 | 選手の所属                                                   |
| 名前                 | 氏名                                                          |
| 各試合の結果         | (1)～(6)試合の勝敗/枚差など                                   |
| 最終勝敗数           | トータル勝数                                                 |
| 順位                 | 優勝、準優勝、ベスト4など（複数優勝時は全員優勝）            |

---

## 8. 今後のステップ

1. **ワイヤーフレームの共有**  
   - すでに想定済みの画面レイアウトを開発者へ提示し、実装に落とし込む。
2. **既存の組み合わせアルゴリズムコードの統合**  
   - 組み合わせロジック（JS）のインターフェースを確認し、ツールと連動させる。
3. **ファイル入出力（CSV, PNG, PDF）** の具体的実装  
   - CSV文字コードの変換、PNG作成（Canvas → 画像）、PDF作成（ライブラリ活用）の検証。
4. **単体テスト** の実施  
   - 各種サンプルCSVを使って入出力が正常に機能するか確認。
5. **利用マニュアル**（操作手順）作成  
   - 運営スタッフが迷わずに使えるよう、入力・出力手順を分かりやすくまとめる。

以上です。  
ご不明点や追加でご要望がありましたらお知らせください。これらを反映したうえで最終的な仕様書を完成させる予定です。
