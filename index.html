<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>対戦組み合わせ生成</title>
  <style>
    body {
      font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      margin: 20px;
      line-height: 1.6;
    }

    h1 {
      text-align: center;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    label {
      font-weight: bold;
    }

    input[type="file"],
    textarea, 
    select {
      display: block;
      margin: 10px 0;
      width: 100%;
      padding: 10px;
      font-size: 14px;
    }

    .drop-zone {
      border: 2px dashed #007BFF;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      color: #555;
      cursor: pointer;
    }

    .drop-zone.dragging {
      background-color: #f1f1f1;
    }

    button {
      display: inline-block;
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
    }

    button:disabled {
      background-color: #CCCCCC;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f4f4f4;
    }

    .center {
      text-align: center;
    }

    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>対戦組み合わせ生成</h1>

    <div>
      <label for="delimiter">区切り文字を選択</label>
      <select id="delimiter">
        <option value=",">カンマ (,)</option>
        <option value="\t">タブ (\t)</option>
        <option value=" ">スペース</option>
      </select>
    </div>

    <div>
      <label for="fileInput">CSVファイルを選択</label>
      <input type="file" id="fileInput" accept=".csv">
    </div>

    <div class="drop-zone" id="dropZone">ここにファイルをドラッグ＆ドロップ</div>

    <div>
      <label for="pasteInput">データをコピーして貼り付け</label>
      <textarea id="pasteInput" rows="10" placeholder="ここにデータを貼り付けてください"></textarea>
    </div>

    <button id="generateButton" disabled>対戦組み合わせを生成</button>
    <button id="downloadButton" disabled>結果をCSVでダウンロード</button>

    <div id="result"></div>
  </div>

  <script>
    let members = []; // データを格納

    const REQUIRED_COLUMNS = ["Id", "級", "所属"];
    const CONDITIONAL_REQUIRED_COLUMNS = [["名前"], ["姓", "名"]];

    const DISPLAY_COLUMNS = ["Id", "名前", "所属"];

    function splitWithDelimiters(text, delimiter) {
      return text.split("\n").map(row => row.trim().split(delimiter));
    }

    function validateColumns(headers) {
      const missingRequired = REQUIRED_COLUMNS.filter(col => !headers.includes(col));
      if (missingRequired.length > 0) {
        return `必須列が不足しています: ${missingRequired.join(", ")}`;
      }
      const satisfiesConditional = CONDITIONAL_REQUIRED_COLUMNS.some(group =>
        group.every(col => headers.includes(col))
      );
      if (!satisfiesConditional) {
        return "名前または (姓, 名) が必要です。";
      }
      return null;
    }

    function normalizeData(data) {
      return data.map(row => {
        if (!row["名前"] && row["姓"] && row["名"]) {
          row["名前"] = `${row["姓"]} ${row["名"]}`;
        }
        return row;
      });
    }

    function parseData(content, delimiter) {
      const rows = splitWithDelimiters(content, delimiter);
      const headers = rows.shift();

      const validationError = validateColumns(headers);
      if (validationError) {
        alert(validationError);
        return { headers: [], data: [] };
      }

      const data = rows.map(row => {
        const obj = {};
        headers.forEach((header, i) => (obj[header] = row[i]));
        return obj;
      });

      return { headers, data: normalizeData(data) };
    }

    function generatePairs(data) {
      const shuffled = data.sort(() => Math.random() - 0.5);
      const pairs = [];
      for (let i = 0; i < shuffled.length; i += 2) {
        pairs.push(shuffled.slice(i, i + 2));
      }
      return pairs;
    }

    function displayPairs(pairs) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      let tableHTML = `<table><thead><tr>${DISPLAY_COLUMNS.map(
        col => `<th>${col}</th>`
      ).join("")}</tr></thead><tbody>`;

      pairs.forEach(pair => {
        tableHTML += `<tr>${DISPLAY_COLUMNS.map(
          col => `<td>${pair[0][col] || ""}</td>`
        ).join("")}</tr>`;

        if (pair[1]) {
          tableHTML += `<tr>${DISPLAY_COLUMNS.map(
            col => `<td>${pair[1][col] || ""}</td>`
          ).join("")}</tr>`;
        } else {
          tableHTML += `<tr><td colspan="${DISPLAY_COLUMNS.length}" class="center">不戦勝</td></tr>`;
        }
        tableHTML += `<tr><td colspan="${DISPLAY_COLUMNS.length}" class="center">--- VS ---</td></tr>`;
      });

      tableHTML += `</tbody></table>`;
      resultDiv.innerHTML = tableHTML;
    }

    function downloadCSV(pairs) {
      let csvContent = `${DISPLAY_COLUMNS.join(",")}\n`;
      pairs.forEach(pair => {
        csvContent += DISPLAY_COLUMNS.map(col => pair[0][col] || "").join(",") + "\n";
        if (pair[1]) {
          csvContent += DISPLAY_COLUMNS.map(col => pair[1][col] || "").join(",") + "\n";
        } else {
          csvContent += "不戦勝".repeat(DISPLAY_COLUMNS.length) + "\n";
        }
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "pairs.csv";
      link.click();
    }

    const dropZone = document.getElementById("dropZone");
    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("dragging");
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("dragging");
    });

    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("dragging");

      const file = e.dataTransfer.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          const delimiter = document.getElementById("delimiter").value;
          const { data } = parseData(e.target.result, delimiter);
          members = data;
          document.getElementById("generateButton").disabled = members.length === 0;
        };
        reader.readAsText(file);
      }
    });

    document.getElementById("fileInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          const delimiter = document.getElementById("delimiter").value;
          const { data } = parseData(e.target.result, delimiter);
          members = data;
          document.getElementById("generateButton").disabled = members.length === 0;
        };
        reader.readAsText(file);
      }
    });

    document.getElementById("pasteInput").addEventListener("input", e => {
      const content = e.target.value.trim();
      const delimiter = document.getElementById("delimiter").value;
      if (content) {
        const { data } = parseData(content, delimiter);
        members = data;
        document.getElementById("generateButton").disabled = members.length === 0;
      } else {
        members = [];
        document.getElementById("generateButton").disabled = true;
      }
    });

    document.getElementById("generateButton").addEventListener("click", () => {
      const pairs = generatePairs(members);
      displayPairs(pairs);
      document.getElementById("downloadButton").disabled = pairs.length === 0;
    });

    document.getElementById("downloadButton").addEventListener("click", () => {
      const pairs = generatePairs(members);
      downloadCSV(pairs);
    });
  </script>
</body>

</html>
